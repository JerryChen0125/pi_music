version: '3.8'

services:
  jukebox:
    build: .
    container_name: pi_jukebox
    ports:
      - "8000:8000"
    restart: unless-stopped
    # --------------------------------------------
    # 藍牙音效設定 (PulseAudio Socket)
    # --------------------------------------------
    environment:
      # 告訴容器音效伺服器在哪裡
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      # 為了避免權限問題，我們讓容器知道 cookie 位置
      - PULSE_COOKIE=/run/user/1000/pulse/cookie
      - HOME=/app
    volumes:
      - ./app:/app
      # 掛載宿主機的 PulseAudio 插座，讓容器可以傳送聲音
      - /run/user/1000/pulse:/run/user/1000/pulse
      # 掛載設定檔以讀取權限 Cookie
      - /home/pi/.config/pulse/cookie:/run/user/1000/pulse/cookie
    # 使用 pi 使用者 (UID 1000) 執行，這樣才有權限用藍牙
    user: "1000:1000"
    group_add:
      - audio